# 代码结构合理性审查规范（Python 工程化）

## 目标

- 为 Paper Tracker 提供统一的“代码结构合理性”审查工作流。
- 在不讨论业务对错的前提下，优先发现分层、依赖、可维护性、可测试性风险。
- 与现有规则保持一致，尤其是：
  - `.ai_docs/rules/code_rules.md`
  - `.ai_docs/rules/project_overview.md`
  - `.ai_docs/rules/testing_rules.md`

## 适用范围

- 适用于 `src/PaperTracker/` 下所有 Python 代码变更。
- 适用于 PR 审查、重构审查、规范化清理审查。
- 默认不评审 UI 文案、产品策略，仅关注结构合理性。

## 审查工作流

### 第 1 步：确认边界和意图

- 明确本次变更属于：
  - 新功能
  - 结构重构（不改行为）
  - 缺陷修复（局部行为改动）
- 明确不可触碰项：CLI 参数面、配置语义、存储 schema、外部协议。

### 第 2 步：做结构映射

- 标注变更落点在哪一层：
  - CLI 层（`cli/`）
  - 配置层（`config/`）
  - 服务层（`services/`）
  - 数据源层（`sources/`）
  - 存储层（`storage/`）
  - 输出层（`renderers/`）
- 检查是否出现跨层直连和反向依赖。

### 第 3 步：按清单审查（见下文）

- 按“阻塞项（Must）→ 改进项（Should）”顺序检查。
- 必须给出文件路径和具体行号。
- 结论格式固定：问题、影响、建议修复。

### 第 4 步：验证与回归

- 结构改动后至少执行一次：
  - `python -m unittest discover -s test -p "test_*.py"`
- 若当前阶段不新增单元测试，至少给出“为何不需要新增测试”的理由。

### 第 5 步：审查结论

- `通过`：无 Must 问题。
- `需修改`：存在 Must 问题，或 Should 问题累计影响可维护性。
- `阻塞`：出现跨层耦合、生命周期错误、配置破坏、依赖反转破坏。

## 审查清单（Must）

### 1) 分层职责清晰

- CLI 层保持薄：只做参数入口、调用 runner/command，不承载业务细节。
- 业务编排在 command/service，I/O 在 source/storage/renderer。
- 输出格式逻辑不得侵入服务层。

### 2) 依赖方向正确

- 允许依赖方向：`cli -> services/config -> sources|storage|renderers`。
- 禁止低层反向依赖高层（例如 `sources` 依赖 `cli`）。
- 禁止循环依赖和“隐式全局单例”驱动逻辑。

### 3) 配置驱动和集中解析

- 新行为应可由配置控制，并提供安全默认值。
- 配置解析必须集中在 `config/`，不要在业务层散落读取 YAML/ENV。
- 跨域约束统一放在配置检查流程（例如 `check_*` 或 `check_cross_domain`）。

### 4) 工程规范一致性

- 本项只检查“是否遵守编码规范”，不在本文重复定义细则。
- 所有编码细则（导入顺序、docstring 策略、函数组织、CLI 约束等）统一以 `.ai_docs/rules/code_rules.md` 为唯一来源。

### 5) 副作用与资源生命周期可控

- 网络、数据库、文件写入等副作用必须在边界层或受控编排层。
- 资源创建/释放路径明确，不允许泄漏连接或隐式状态污染。
- 错误处理要可预期：失败路径不应破坏主流程可观测性。

### 6) 可测试性不被破坏

- 核心逻辑应可注入依赖，不绑定具体实现。
- 新增结构若降低可替换性（mock/stub 困难），视为 Must 问题。
- 关键分支变更需有对应验证（测试或可复现实验步骤）。

## 审查清单（Should）

### 1) 模块内聚与复杂度

- 单文件、单类职责不过载；出现“上帝对象”应建议拆分。
- 控制函数长度和嵌套深度，避免难以维护的流程函数。

### 2) 命名与可读性

- 模块名、类名、函数名反映真实职责，不使用含糊缩写。
- 日志语义清晰，避免无上下文日志。

### 3) 类型与边界契约

- 公开接口参数和返回值有明确类型。
- 减少无必要 `Any`、`type: ignore`，优先精确类型表达。

### 4) 扩展点设计

- 新能力优先通过协议/工厂扩展，不在核心流程堆叠 if-else 分支。
- 变更应复用现有 factory 和协议抽象，避免旁路构造。

## 问题分级标准

- P0（阻塞）：架构方向错误、反向依赖、配置语义破坏、生命周期风险。
- P1（高）：分层职责明显混乱、可测试性显著下降、扩展点被硬编码破坏。
- P2（中）：结构可运行但维护成本高，如职责过载、命名和边界不清晰。
- P3（低）：风格一致性问题，不影响当前结构正确性。

## 审查输出模板（建议）

- 文件：`path/to/file.py:line`
- 级别：`P0|P1|P2|P3`
- 问题：一句话描述结构问题。
- 影响：对维护、扩展、测试或稳定性的影响。
- 建议：最小改动修复方案。

## 与现有规则的关系（收敛说明）

- 本文档聚焦“结构审查流程与判定标准”。
- `code_*` 中的“编码要求”已收敛到 `.ai_docs/rules/code_rules.md`，本文不再重复编码条款。
- 架构分层认知以 `.ai_docs/rules/project_overview.md` 为准。
- 测试执行与范围以 `.ai_docs/rules/testing_rules.md` 为准。
